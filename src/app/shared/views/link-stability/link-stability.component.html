<div class="p-4">
  <h2 class="text-xl font-semibold mb-4">Link Stability Analysis</h2>

  <!-- Controls Section -->
  <div class="mb-4 flex flex-wrap gap-4 items-center">
    <div>
      <label for="dataLimit" class="mr-2 font-medium">Show last:</label>
      <select id="dataLimit"
              [(ngModel)]="dataLimit"
              (change)="onDataLimitChange()"
              class="border px-2 py-1 rounded">
        <option *ngFor="let limit of dataLimits" [value]="limit">
          {{ limit === -1 ? 'All' : limit }}
        </option>
      </select>
    </div>

    <button 
      (click)="calculateTimeDeviation()"
      [disabled]="isLoading || filteredData.length < 10"
      class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
      {{ isLoading ? 'Calculating...' : 'Calculate Time Deviation (TDEV)' }}
    </button>
  </div>

  <!-- Error Display -->
  <div *ngIf="error" class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
    {{ error }}
  </div>

  <!-- Data Summary -->
  <div class="mb-4 p-3 bg-gray-50 rounded">
    <p class="text-sm text-gray-600">
      Data Points: {{ displayedDataCount }} | 
      Filter: {{ selectedFilter === 'ALL' ? 'All Satellites' : selectedFilter }} |
      Location: {{ dataIdentifier | titlecase }}
    </p>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="flex items-center justify-center py-12">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    <span class="ml-3 text-lg text-gray-600">Processing...</span>
  </div>

  <!-- CV Diff Plot -->
  <div *ngIf="plotChartData && !isLoading && isBrowser" class="mb-6">
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">CV Diff for {{ dataIdentifier | titlecase }}</h3>
        <button 
          (click)="downloadPlotCSV()"
          class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm">
          Download CSV
        </button>
      </div>
      
      <div class="h-96">
        <canvas baseChart
                [data]="plotChartData"
                [options]="plotChartOptions"
                [type]="'line'">
        </canvas>
      </div>

      <!-- Legend -->
      <div class="mt-4 flex flex-wrap gap-4 text-sm">
        <div class="flex items-center">
          <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
          <span>Time difference within ±30 ns</span>
        </div>
        <div class="flex items-center">
          <span class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></span>
          <span>Time difference 30-50 ns</span>
        </div>
        <div class="flex items-center">
          <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
          <span>Time difference > 50 ns</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Time Deviation Analysis Section -->
  <div *ngIf="showTdevAnalysis && tdevChartData && !isLoading && isBrowser" class="mb-6">
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Time Deviation (TDEV) Analysis</h3>
        <button 
          (click)="downloadTdevCSV()"
          class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm">
          Download TDEV & MDEV in CSV
        </button>
      </div>
      
      <div class="h-96">
        <canvas baseChart
                [data]="tdevChartData"
                [options]="tdevChartOptions"
                [type]="'line'">
        </canvas>
      </div>

      <!-- TDEV Information -->
      <div class="mt-4 p-4 bg-blue-50 rounded-lg">
        <h4 class="font-medium mb-2">About Time Deviation (TDEV) - All Receivers Analysis</h4>
        <p class="text-sm text-gray-700 mb-2">
          Time Deviation (TDEV) and Modified Allan Deviation (MDEV) are measures of frequency stability that characterize 
          the time error accumulated over different averaging intervals. This analysis shows individual TDEV/MDEV calculations 
          for each receiver at {{ dataIdentifier | titlecase }}, calculated using Common View Difference data from each receiver separately.
        </p>
        <p class="text-sm text-gray-700 mb-2">
          <strong>Formula:</strong> TDEV(τ) = τ × MDEV(τ) / √3 <br>
          <strong>Data Source:</strong> CV Difference values for each receiver individually <br>
          <strong>Visualization:</strong> Dashed lines = MDEV, Solid lines = TDEV
        </p>
        <p class="text-sm text-gray-600">
          Each receiver is plotted with a consistent color scheme matching the main plot view.
        </p>
      </div>
    </div>
  </div>

  <!-- No Data Message -->
  <div *ngIf="!plotChartData && !isLoading && filteredData.length === 0" 
       class="text-center py-12 text-gray-500">
    <p>No data available for the selected filters.</p>
    <p class="text-sm mt-2">Try adjusting the filter criteria or date range.</p>
  </div>
</div>
